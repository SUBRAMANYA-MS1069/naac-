{'role': 'assistant', 'content': 'Let\'s continue creating more services:\n\n<function_calls>\n<create-file file_path="src/services/expenditure/billService.js">\nconst Bill = require(\'../../models/expenditure/Bill\');\nconst Vendor = require(\'../../models/expenditure/Vendor\');\nconst PurchaseOrder = require(\'../../models/expenditure/PurchaseOrder\');\nconst { AppError } = require(\'../../utils/helpers/errorHelper\');\n\n/**\n * Create a new bill\n * @param {Object} billData - Bill data\n * @param {String} tenantId - Tenant ID\n * @param {String} userId - User ID\n * @returns {Object} Created bill\n */\nconst createBill = async (billData, tenantId, userId) => {\n  try {\n    // Add tenantId to bill data\n    billData.tenantId = tenantId;\n    \n    // Check if vendor exists and is active\n    const vendor = await Vendor.findOne({ \n      vendorId: billData.vendorId, \n      tenantId,\n      isActive: true \n    });\n    \n    if (!vendor) {\n      throw new AppError(\'Vendor not found or inactive\', 404, \'VENDOR_NOT_FOUND\');\n    }\n    \n    // Check if PO exists (if provided)\n    if (billData.purchaseOrderId) {\n      const po = await PurchaseOrder.findOne({ \n        poId: billData.purchaseOrderId, \n        tenantId \n      });\n      \n      if (!po) {\n        throw new AppError(\'Purchase order not found\', 404, \'PO_NOT_FOUND\');\n      }\n    }\n    \n    // Calculate totals\n    let subtotal = 0;\n    let taxTotal = 0;\n    \n    for (const item of billData.lineItems) {\n      const itemTotal = item.quantity * item.unitPrice;\n      const itemTax = itemTotal * (item.taxRate / 100);\n      \n      item.totalAmount = itemTotal + itemTax;\n      subtotal += itemTotal;\n      taxTotal += itemTax;\n    }\n    \n    billData.subtotal = subtotal;\n    billData.taxTotal = taxTotal;\n    billData.totalAmount = subtotal + taxTotal + (billData.otherCharges || 0);\n    billData.balanceAmount = billData.totalAmount;\n    \n    // Create bill\n    const bill = new Bill(billData);\n    await bill.save();\n    \n    return bill;\n  } catch (error) {\n    if (error.code === 11000) {\n      throw new AppError(\'Bill with this number already exists\', 409, \'DUPLICATE_BILL\');\n    }\n    throw error;\n  }\n};\n\n/**\n * Get bills with filters\n * @param {Object} filters - Filter criteria\n * @param {Object} pagination - Pagination options\n * @param {String} tenantId - Tenant ID\n * @returns {Object} Bills and pagination info\n */\nconst getBills = async (filters, pagination, tenantId) => {\n  try {\n    const query = { tenantId, ...filters };\n    \n    // Handle vendor filter\n    if (filters.vendorId) {\n      query.vendorId = filters.vendorId;\n    }\n    \n    // Handle status filter\n    if (filters.status) {\n      query.status = filters.status;\n    }\n    \n    // Handle bill type filter\n    if (filters.billType) {\n      query.billType = filters.billType;\n    }\n    \n    // Handle date range filter\n    if (filters.startDate || filters.endDate) {\n      query.billDate = {};\n      if (filters.startDate) {\n        query.billDate.$gte = new Date(filters.startDate);\n      }\n      if (filters.endDate) {\n        query.billDate.$lte = new Date(filters.endDate);\n      }\n    }\n    \n    const bills = await Bill.find(query)\n      .sort(pagination.sort || \'-billDate\')\n      .skip(pagination.skip)\n      .limit(pagination.limit)\n      .populate(\'vendorId\', \'vendorName vendorCode\')\n      .populate(\'purchaseOrderId\', \'poNumber\');\n    \n    const total = await Bill.countDocuments(query);\n    \n    return {\n      bills,\n      total,\n      page: pagination.page,\n      limit: pagination.limit\n    };\n  } catch (error) {\n    throw new AppError(\'Failed to fetch bills\', 500, \'FETCH_BILLS_ERROR\');\n  }\n};\n\n/**\n * Get bill by ID\n * @param {String} billId - Bill ID\n * @param {String} tenantId - Tenant ID\n * @returns {Object} Bill\n */\nconst getBillById = async (billId, tenantId) => {\n  try {\n    const bill = await Bill.findOne({ billId, tenantId })\n      .populate(\'vendorId\', \'vendorName vendorCode contactPerson address\')\n      .populate(\'purchaseOrderId\', \'poNumber poDate\');\n    \n    if (!bill) {\n      throw new AppError(\'Bill not found\', 404, \'BILL_NOT_FOUND\');\n    }\n    \n    return bill;\n  } catch (error) {\n    if (error.name === \'CastError\') {\n      throw new AppError(\'Invalid bill ID\', 400, \'INVALID_BILL_ID\');\n    }\n    throw error;\n  }\n};\n\n/**\n * Update bill\n * @param {String} billId - Bill ID\n * @param {Object} updateData - Update data\n * @param {String} tenantId - Tenant ID\n * @returns {Object} Updated bill\n */\nconst updateBill = async (billId, updateData, tenantId) => {\n  try {\n    // Prevent updating paid bills\n    const existingBill = await Bill.findOne({ billId, tenantId });\n    \n    if (!existingBill) {\n      throw new AppError(\'Bill not found\', 404, \'BILL_NOT_FOUND\');\n    }\n    \n    if (existingBill.status === \'Paid\') {\n      throw new AppError(\'Cannot update paid bill\', 400, \'CANNOT_UPDATE_PAID_BILL\');\n    }\n    \n    // Recalculate totals if line items are updated\n    if (updateData.lineItems) {\n      let subtotal = 0;\n      let taxTotal = 0;\n      \n      for (const item of updateData.lineItems) {\n        const itemTotal = item.quantity * item.unitPrice;\n        const itemTax = itemTotal * (item.taxRate / 100);\n        \n        item.totalAmount = itemTotal + itemTax;\n        subtotal += itemTotal;\n        taxTotal += itemTax;\n      }\n      \n      updateData.subtotal = subtotal;\n      updateData.taxTotal = taxTotal;\n      updateData.totalAmount = subtotal + taxTotal + (updateData.otherCharges || 0);\n      \n      // Update balance amount if not explicitly set\n      if (updateData.paidAmount === undefined) {\n        updateData.balanceAmount = updateData.totalAmount - (existingBill.paidAmount || 0);\n      } else {\n        updateData.balanceAmount = updateData.totalAmount - updateData.paidAmount;\n      }\n    }\n    \n    const bill = await Bill.findOneAndUpdate(\n      { billId, tenantId },\n      updateData,\n      { new: true, runValidators: true }\n    );\n    \n    return bill;\n  } catch (error) {\n    if (error.name === \'CastError\') {\n      throw new AppError(\'Invalid bill ID\', 400, \'INVALID_BILL_ID\');\n    }\n    throw error;\n  }\n};\n\n/**\n * Approve bill\n * @param {String} billId - Bill ID\n * @param {String} tenantId - Tenant ID\n * @param {String} userId - User ID\n * @returns {Object} Approved bill\n */\nconst approveBill = async (billId, tenantId, userId) => {\n  try {\n    const bill = await Bill.findOne({ billId, tenantId });\n    \n    if (!bill) {\n      throw new AppError(\'Bill not found\', 404, \'BILL_NOT_FOUND\');\n    }\n    \n    if (bill.status !== \'Pending\') {\n      throw new AppError(\'Bill is not in pending status\', 400, \'INVALID_BILL_STATUS\');\n    }\n    \n    bill.status = \'Approved\';\n    bill.approvedBy = userId;\n    bill.approvedDate = new Date();\n    \n    await bill.save();\n    \n    return bill;\n  } catch (error) {\n    if (error.name === \'CastError\') {\n      throw new AppError(\'Invalid bill ID\', 400, \'INVALID_BILL_ID\');\n    }\n    throw error;\n  }\n};\n\n/**\n * Record bill payment\n * @param {String} billId - Bill ID\n * @param {Number} amount - Payment amount\n * @param {String} tenantId - Tenant ID\n * @returns {Object} Updated bill\n */\nconst recordBillPayment = async (billId, amount, tenantId) => {\n  try {\n    const bill = await Bill.findOne({ billId, tenantId });\n    \n    if (!bill) {\n      throw new AppError(\'Bill not found\', 404, \'BILL_NOT_FOUND\');\n    }\n    \n    if (bill.status !== \'Approved\') {\n      throw new AppError(\'Bill must be approved before payment\', 400, \'BILL_NOT_APPROVED\');\n    }\n    \n    const newPaidAmount = (bill.paidAmount || 0) + amount;\n    \n    if (newPaidAmount > bill.totalAmount) {\n      throw new AppError(\'Payment amount exceeds bill total\', 400, \'PAYMENT_EXCEEDS_TOTAL\');\n    }\n    \n    bill.paidAmount = newPaidAmount;\n    bill.balanceAmount = bill.totalAmount - newPaidAmount;\n    \n    // Update status based on payment\n    if (bill.balanceAmount === 0) {\n      bill.status = \'Paid\';\n    } else {\n      bill.status = \'PartiallyPaid\';\n    }\n    \n    await bill.save();\n    \n    return bill;\n  } catch (error) {\n    if (error.name === \'CastError\') {\n      throw new AppError(\'Invalid bill ID\', 400, \'INVALID_BILL_ID\');\n    }\n    throw error;\n  }\n};\n\nmodule.exports = {\n  createBill,\n  getBills,\n  getBillById,\n  updateBill,\n  approveBill,\n  recordBillPayment\n};\n</create-file>\n</function_calls>'}