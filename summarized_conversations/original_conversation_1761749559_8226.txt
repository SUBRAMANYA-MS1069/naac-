{'role': 'assistant', 'content': 'Let\'s continue creating more services:\n\n<function_calls>\n<create-file file_path="src/services/budget/budgetCalculationService.js">\nconst BudgetLine = require(\'../../models/budget/BudgetLine\');\nconst Transaction = require(\'../../models/finance/Transaction\');\nconst { calculateBudgetVariance, calculateBudgetUtilization } = require(\'../../utils/calculators/budgetCalculator\');\nconst { AppError } = require(\'../../utils/helpers/errorHelper\');\n\n/**\n * Calculate budget vs actuals\n * @param {String} budgetId - Budget ID\n * @param {String} tenantId - Tenant ID\n * @returns {Array} Budget vs actuals data\n */\nconst calculateBudgetVsActuals = async (budgetId, tenantId) => {\n  try {\n    // Get budget lines\n    const budgetLines = await BudgetLine.find({ budgetId, tenantId });\n    \n    // Get actual transactions for budget period\n    const actuals = await getActualsForBudgetLines(budgetLines, tenantId);\n    \n    // Calculate variances\n    const budgetVsActuals = budgetLines.map(line => {\n      const actualAmount = actuals[line.accountId] || 0;\n      const varianceData = calculateBudgetVariance(line.totalBudget, actualAmount);\n      \n      return {\n        budgetLineId: line.budgetLineId,\n        accountId: line.accountId,\n        accountName: line.accountName,\n        budgetCategory: line.budgetCategory,\n        budgetedAmount: line.totalBudget,\n        actualAmount,\n        variance: varianceData.variance,\n        variancePercentage: varianceData.variancePercentage,\n        status: varianceData.status\n      };\n    });\n    \n    return budgetVsActuals;\n  } catch (error) {\n    throw new AppError(\'Failed to calculate budget vs actuals\', 500, \'BUDGET_VS_ACTUALS_ERROR\');\n  }\n};\n\n/**\n * Get actuals for budget lines\n * @param {Array} budgetLines - Budget lines\n * @param {String} tenantId - Tenant ID\n * @returns {Object} Actual amounts by account\n */\nconst getActualsForBudgetLines = async (budgetLines, tenantId) => {\n  try {\n    const accountIds = budgetLines.map(line => line.accountId);\n    \n    // Get transactions for accounts\n    const transactions = await Transaction.find({\n      tenantId,\n      accountId: { $in: accountIds }\n    });\n    \n    // Group transactions by account\n    const actuals = {};\n    \n    transactions.forEach(transaction => {\n      if (!actuals[transaction.accountId]) {\n        actuals[transaction.accountId] = 0;\n      }\n      \n      if (transaction.transactionType === \'Debit\') {\n        // For expense accounts, debit increases the actual spending\n        if (transaction.accountId === transaction.accountId) {\n          actuals[transaction.accountId] += transaction.amount;\n        }\n      } else {\n        // For income accounts, credit increases the actual income\n        if (transaction.accountId === transaction.accountId) {\n          actuals[transaction.accountId] += transaction.amount;\n        }\n      }\n    });\n    \n    return actuals;\n  } catch (error) {\n    throw new AppError(\'Failed to get actuals for budget lines\', 500, \'GET_ACTUALS_ERROR\');\n  }\n};\n\n/**\n * Calculate quarterly budget utilization\n * @param {String} budgetId - Budget ID\n * @param {String} tenantId - Tenant ID\n * @returns {Array} Quarterly utilization data\n */\nconst calculateQuarterlyUtilization = async (budgetId, tenantId) => {\n  try {\n    // Get budget lines\n    const budgetLines = await BudgetLine.find({ budgetId, tenantId });\n    \n    // Calculate utilization for each line\n    const quarterlyUtilization = budgetLines.map(line => {\n      const quarterlyData = line.quarters.map(quarter => {\n        // In a real implementation, you would get actuals for each quarter\n        // For now, we\'ll use placeholder data\n        const actualAmount = quarter.amount * (Math.random() * 0.8); // Random utilization\n        const utilization = calculateBudgetUtilization(quarter.amount, actualAmount);\n        \n        return {\n          quarter: quarter.quarter,\n          budgetedAmount: quarter.amount,\n          actualAmount,\n          utilization\n        };\n      });\n      \n      return {\n        budgetLineId: line.budgetLineId,\n        accountName: line.accountName,\n...\n The full message content is stored at /workspace/summarized_conversations/original_conversation_1761749429_6993.txt'}