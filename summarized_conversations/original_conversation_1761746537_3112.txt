{'role': 'assistant', 'content': 'Let\'s continue creating the services for other modules:\n\n<function_calls>\n<create-file file_path="src/services/budget/budgetService.js">\nconst Budget = require(\'../../models/budget/Budget\');\nconst BudgetLine = require(\'../../models/budget/BudgetLine\');\nconst { AppError } = require(\'../../utils/helpers/errorHelper\');\nconst { calculateTotalBudget } = require(\'../../utils/calculators/budgetCalculator\');\n\n/**\n * Create a new budget\n * @param {Object} budgetData - Budget data\n * @param {String} tenantId - Tenant ID\n * @param {String} userId - User ID\n * @returns {Object} Created budget\n */\nconst createBudget = async (budgetData, tenantId, userId) => {\n  try {\n    // Add tenantId and preparedBy to budget data\n    budgetData.tenantId = tenantId;\n    budgetData.preparedBy = userId;\n    \n    // Calculate totals from budget lines\n    let totalIncome = 0;\n    let totalExpense = 0;\n    \n    for (const line of budgetData.budgetLines) {\n      const totalBudget = calculateTotalBudget(line.quarters);\n      line.totalBudget = totalBudget;\n      \n      if (line.budgetCategory === \'Income\') {\n        totalIncome += totalBudget;\n      } else {\n        totalExpense += totalBudget;\n      }\n    }\n    \n    budgetData.totalIncome = totalIncome;\n    budgetData.totalExpense = totalExpense;\n    budgetData.netBudget = totalIncome - totalExpense;\n    \n    // Create budget\n    const budget = new Budget(budgetData);\n    await budget.save();\n    \n    // Create budget lines\n    const budgetLines = budgetData.budgetLines.map(line => ({\n      ...line,\n      tenantId,\n      budgetId: budget.budgetId\n    }));\n    \n    await BudgetLine.insertMany(budgetLines);\n    \n    // Fetch budget with lines\n    const budgetWithLines = await Budget.findOne({ budgetId: budget.budgetId, tenantId })\n      .populate(\'budgetLines\');\n    \n    return budgetWithLines;\n  } catch (error) {\n    if (error.code === 11000) {\n      throw new AppError(\'Budget with this name already exists\', 409, \'DUPLICATE_BUDGET_NAME\');\n    }\n    throw error;\n  }\n};\n\n/**\n * Get budgets with filters\n * @param {Object} filters - Filter criteria\n * @param {Object} pagination - Pagination options\n * @param {String} tenantId - Tenant ID\n * @returns {Object} Budgets and pagination info\n */\nconst getBudgets = async (filters, pagination, tenantId) => {\n  try {\n    const query = { tenantId, ...filters };\n    \n    // Handle status filter\n    if (filters.status) {\n      query.status = filters.status;\n    }\n    \n    // Handle financial year filter\n    if (filters.financialYear) {\n      query.financialYear = filters.financialYear;\n    }\n    \n    const budgets = await Budget.find(query)\n      .sort(pagination.sort || \'-createdAt\')\n      .skip(pagination.skip)\n      .limit(pagination.limit)\n      .populate(\'preparedBy\', \'name email\');\n    \n    const total = await Budget.countDocuments(query);\n    \n    return {\n      budgets,\n      total,\n      page: pagination.page,\n      limit: pagination.limit\n    };\n  } catch (error) {\n    throw new AppError(\'Failed to fetch budgets\', 500, \'FETCH_BUDGETS_ERROR\');\n  }\n};\n\n/**\n * Get budget by ID\n * @param {String} budgetId - Budget ID\n * @param {String} tenantId - Tenant ID\n * @returns {Object} Budget\n */\nconst getBudgetById = async (budgetId, tenantId) => {\n  try {\n    const budget = await Budget.findOne({ budgetId, tenantId })\n      .populate(\'preparedBy\', \'name email\')\n      .populate(\'approvers\', \'name email\')\n      .populate(\'approvedBy\', \'name email\');\n    \n    if (!budget) {\n      throw new AppError(\'Budget not found\', 404, \'BUDGET_NOT_FOUND\');\n    }\n    \n    // Get budget lines\n    const budgetLines = await BudgetLine.find({ budgetId: budget.budgetId, tenantId });\n    budget.budgetLines = budgetLines;\n    \n    return budget;\n  } catch (error) {\n    if (error.name === \'CastError\') {\n      throw new AppError(\'Invalid budget ID\', 400, \'INVALID_BUDGET_ID\');\n    }\n    throw error;\n  }\n};\n\n/**\n * Update budget\n * @param {String} budgetId - Budget ID\n * @param {Object} updateData - Update data\n * @param {String} tenantId - Tenant ID\n * @returns {Object} Updated budget\n */\nconst updateBudget = async (budgetId, updateData, tenantId) => {\n  try {\n    // Prevent updating approved/closed budgets\n    const existingBudget = await Budget.findOne({ budgetId, tenantId });\n    \n    if (!existingBudget) {\n      throw new AppError(\'Budget not found\', 404, \'BUDGET_NOT_FOUND\');\n    }\n    \n    if ([\'Approved\', \'Closed\'].includes(existingBudget.status)) {\n      throw new AppError(\'Cannot update approved or closed budgets\', 400, \'CANNOT_UPDATE_APPROVED_BUDGET\');\n    }\n    \n    const budget = await Budget.findOneAndUpdate(\n      { budgetId, tenantId },\n      updateData,\n      { new: true, runValidators: true }\n    );\n    \n    return budget;\n  } catch (error) {\n    if (error.name === \'CastError\') {\n      throw new AppError(\'Invalid budget ID\', 400, \'INVALID_BUDGET_ID\');\n    }\n    throw error;\n  }\n};\n\n/**\n * Submit budget for approval\n * @param {String} budgetId - Budget ID\n * @param {String} tenantId - Tenant ID\n * @param {String} userId - User ID\n * @returns {Object} Submitted budget\n */\nconst submitBudget = async (budgetId, tenantId, userId) => {\n  try {\n    const budget = await Budget.findOne({ budgetId, tenantId });\n    \n    if (!budget) {\n      throw new AppError(\'Budget not found\', 404, \'BUDGET_NOT_FOUND\');\n    }\n    \n    if (budget.status !== \'Draft\') {\n      throw new AppError(\'Only draft budgets can be submitted\', 400, \'BUDGET_NOT_DRAFT\');\n    }\n    \n    budget.status = \'Submitted\';\n    budget.submittedBy = userId;\n    budget.submittedDate = new Date();\n    \n    await budget.save();\n    \n    return budget;\n  } catch (error) {\n    if (error.name === \'CastError\') {\n      throw new AppError(\'Invalid budget ID\', 400, \'INVALID_BUDGET_ID\');\n    }\n    throw error;\n  }\n};\n\n/**\n * Approve budget\n * @param {String} budgetId - Budget ID\n * @param {String} tenantId - Tenant ID\n * @param {String} userId - User ID\n * @returns {Object} Approved budget\n */\nconst approveBudget = async (budgetId, tenantId, userId) => {\n  try {\n    const budget = await Budget.findOne({ budgetId, tenantId });\n    \n    if (!budget) {\n      throw new AppError(\'Budget not found\', 404, \'BUDGET_NOT_FOUND\');\n    }\n    \n    if (budget.status !== \'Submitted\') {\n      throw new AppError(\'Only submitted budgets can be approved\', 400, \'BUDGET_NOT_SUBMITTED\');\n    }\n    \n    budget.status = \'Approved\';\n    budget.approvedBy = userId;\n    budget.approvedDate = new Date();\n    \n    await budget.save();\n    \n    return budget;\n  } catch (error) {\n    if (error.name === \'CastError\') {\n      throw new AppError(\'Invalid budget ID\', 400, \'INVALID_BUDGET_ID\');\n    }\n    throw error;\n  }\n};\n\n/**\n * Activate budget\n * @param {String} budgetId - Budget ID\n * @param {String} tenantId - Tenant ID\n * @returns {Object} Activated budget\n */\nconst activateBudget = async (budgetId, tenantId) => {\n  try {\n    const budget = await Budget.findOne({ budgetId, tenantId });\n    \n    if (!budget) {\n      throw new AppError(\'Budget not found\', 404, \'BUDGET_NOT_FOUND\');\n    }\n    \n    if (budget.status !== \'Approved\') {\n      throw new AppError(\'Only approved budgets can be activated\', 400, \'BUDGET_NOT_APPROVED\');\n    }\n    \n    budget.status = \'Active\';\n    budget.isCurrent = true;\n    \n    // Deactivate other budgets for the same financial year\n    await Budget.updateMany(\n      { \n        tenantId, \n        financialYear: budget.financialYear, \n        budgetId: { $ne: budgetId },\n        isCurrent: true\n      },\n      { isCurrent: false }\n    );\n    \n    await budget.save();\n    \n    return budget;\n  } catch (error) {\n    if (error.name === \'CastError\') {\n      throw new AppError(\'Invalid budget ID\', 400, \'INVALID_BUDGET_ID\');\n    }\n    throw error;\n  }\n};\n\n/**\n * Close budget\n * @param {String} budgetId - Budget ID\n * @param {String} tenantId - Tenant ID\n * @param {String} userId - User ID\n * @param {String} reason - Closure reason\n * @returns {Object} Closed budget\n */\nconst closeBudget = async (budgetId, tenantId, userId, reason) => {\n  try {\n    const budget = await Budget.findOne({ budgetId, tenantId });\n    \n    if (!budget) {\n      throw new AppError(\'Budget not found\', 404, \'BUDGET_NOT_FOUND\');\n    }\n    \n    budget.status = \'Closed\';\n    budget.closedBy = userId;\n    budget.closedDate = new Date();\n    budget.closureReason = reason;\n    \n    await budget.save();\n    \n    return budget;\n  } catch (error) {\n    if (error.name === \'CastError\') {\n      throw new AppError(\'Invalid budget ID\', 400, \'INVALID_BUDGET_ID\');\n    }\n    throw error;\n  }\n};\n\nmodule.exports = {\n  createBudget,\n  getBudgets,\n  getBudgetById,\n  updateBudget,\n  submitBudget,\n  approveBudget,\n  activateBudget,\n  closeBudget\n};\n</create-file>\n</function_calls>'}