{'role': 'assistant', 'content': '<function_calls>\n<create-file file_path="src/services/finance/balanceService.js">\nconst Account = require(\'../../models/finance/Account\');\nconst Transaction = require(\'../../models/finance/Transaction\');\nconst { calculateAccountBalance } = require(\'../../utils/calculators/balanceCalculator\');\nconst { AppError } = require(\'../../utils/helpers/errorHelper\');\n\n/**\n * Get trial balance\n * @param {String} tenantId - Tenant ID\n * @param {Date} asOfDate - Date to calculate balance as of\n * @returns {Array} Trial balance data\n */\nconst getTrialBalance = async (tenantId, asOfDate = null) => {\n  try {\n    // Get all active accounts\n    const accounts = await Account.find({ tenantId, isActive: true });\n    \n    // Build transaction query\n    const transactionQuery = { tenantId };\n    \n    // Add date filter if provided\n    if (asOfDate) {\n      transactionQuery.transactionDate = { $lte: new Date(asOfDate) };\n    }\n    \n    // Get all transactions\n    const transactions = await Transaction.find(transactionQuery);\n    \n    // Group transactions by account\n    const transactionsByAccount = {};\n    transactions.forEach(transaction => {\n      if (!transactionsByAccount[transaction.accountId]) {\n        transactionsByAccount[transaction.accountId] = [];\n      }\n      transactionsByAccount[transaction.accountId].push(transaction);\n    });\n    \n    // Calculate balance for each account\n    const trialBalance = [];\n    \n    for (const account of accounts) {\n      const accountTransactions = transactionsByAccount[account.accountId] || [];\n      const balanceDetails = calculateAccountBalance(accountTransactions, account.openingBalance);\n      \n      trialBalance.push({\n        accountId: account.accountId,\n        accountCode: account.accountCode,\n        accountName: account.accountName,\n        accountType: account.accountType,\n        openingBalance: balanceDetails.openingBalance,\n        debitTotal: balanceDetails.debitTotal,\n        creditTotal: balanceDetails.creditTotal,\n        currentBalance: balanceDetails.currentBalance\n      });\n    }\n    \n    return trialBalance;\n  } catch (error) {\n    throw new AppError(\'Failed to generate trial balance\', 500, \'TRIAL_BALANCE_ERROR\');\n  }\n};\n\n/**\n * Get account ledger\n * @param {String} accountId - Account ID\n * @param {String} tenantId - Tenant ID\n * @param {Date} startDate - Start date\n * @param {Date} endDate - End date\n * @returns {Object} Account ledger data\n */\nconst getAccountLedger = async (accountId, tenantId, startDate = null, endDate = null) => {\n  try {\n    // Get account\n    const account = await Account.findOne({ accountId, tenantId });\n    \n    if (!account) {\n      throw new AppError(\'Account not found\', 404, \'ACCOUNT_NOT_FOUND\');\n    }\n    \n    // Build transaction query\n    const transactionQuery = { accountId, tenantId };\n    \n    // Add date range filter\n    if (startDate || endDate) {\n      transactionQuery.transactionDate = {};\n      if (startDate) {\n        transactionQuery.transactionDate.$gte = new Date(startDate);\n      }\n      if (endDate) {\n        transactionQuery.transactionDate.$lte = new Date(endDate);\n      }\n    }\n    \n    // Get transactions\n    const transactions = await Transaction.find(transactionQuery)\n      .sort(\'transactionDate\')\n      .populate(\'journalEntryId\', \'entryNumber entryDate description\');\n    \n    // Calculate running balance\n    let runningBalance = account.openingBalance || 0;\n    \n    const ledgerEntries = transactions.map(transaction => {\n      if (transaction.transactionType === \'Debit\') {\n        runningBalance -= transaction.amount;\n      } else {\n        runningBalance += transaction.amount;\n      }\n      \n      return {\n        transactionId: transaction.transactionId,\n        transactionDate: transaction.transactionDate,\n        journalEntryId: transaction.journalEntryId,\n        entryNumber: transaction.journalEntryId?.entryNumber,\n        description: transaction.description || transaction.journalEntryId?.description,\n        debit: transaction.transactionType === \'Debit\' ? transaction.amount : 0,\n        credit: transaction.trans...\n The full message content is stored at /workspace/summarized_conversations/original_conversation_1761752221_1165.txt'}